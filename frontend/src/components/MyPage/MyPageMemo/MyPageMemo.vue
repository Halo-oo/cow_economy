<template>
  <div class="pa-1 memo">
    {{ articles_all.length }}
    <v-row class="pb-5">
      <v-col cols="4"
        ><v-select
          v-model="range"
          :items="['전체', '기사 제목', '인용구', '메모 내용']"
          dense
          hide-details
        ></v-select
      ></v-col>
      <v-col
        ><v-text-field
          placeholder="검색어를 입력해 주세요"
          dense
          hide-details
        ></v-text-field
      ></v-col>
    </v-row>
    <v-expansion-panels class="swiper-item" accordion multiple tile flat>
      <v-virtual-scroll>
        <v-expansion-panel v-for="(memoDto, i) in articles" :key="i">
          <v-expansion-panel-header>
            <v-row class="align-center"
              ><v-col cols="10">{{ memoDto.articleTitle }}</v-col
              ><v-col cols="1"
                ><v-btn
                  icon
                  text
                  color="var(--main-col-3)"
                  small
                  @click="moveNewsDetail(memoDto.articleId)"
                  ><v-icon small> mdi-link-variant </v-icon></v-btn
                ></v-col
              >
            </v-row>
          </v-expansion-panel-header>
          <v-expansion-panel-content>
            <v-sheet class="py-1" v-for="(m, i) in memoDto.memoList" :key="i">
              <!-- header -->
              <v-sheet
                class="px-4 sm-font d-flex align-center justify-space-between flex-row"
                color="var(--main-col-3)"
                dark
                small
                block
                rounded="xl"
              >
                <span>{{ m.regtime }}</span>
                <div>
                  <NewsDetailMemoBtnLock
                    :memoPublicScope="m.memoPublicScope"
                    :index="i"
                    color="white"
                    :memoId="m.memoId"
                  ></NewsDetailMemoBtnLock>
                  <NewsDetailMemoBtnDelete
                    :memoId="m.memoId"
                    :index="i"
                    color="white"
                  ></NewsDetailMemoBtnDelete>
                </div>
              </v-sheet>
              <!-- reference -->
              <div
                v-if="m.referenceText"
                class="ma-2 pa-2 border-left font-italic xs-font"
              >
                <div>{{ m.referenceText }}</div>
              </div>
              <!-- content -->
              <div class="ma-2 sm-font">{{ m.memoContent }}</div>
            </v-sheet>
            <v-divider class="mt-2"></v-divider>
          </v-expansion-panel-content>
        </v-expansion-panel>
      </v-virtual-scroll>
    </v-expansion-panels>
    <!-- scroll loading -->
    <v-sheet
      v-if="articles.length === 0 && articles_all.length > 0"
      class="d-flex justify-center"
    >
      <v-progress-circular indeterminate color="primary" class="bottom" />
    </v-sheet>
  </div>
</template>

<script>
import NewsDetailMemoBtnDelete from "@/components/NewsDetail/NewsDetailMemo/NewsDetailMemoBtnDelete.vue";
import NewsDetailMemoBtnLock from "@/components/NewsDetail/NewsDetailMemo/NewsDetailMemoBtnLock.vue";

export default {
  name: "MyPageMemo",
  components: {
    NewsDetailMemoBtnDelete,
    NewsDetailMemoBtnLock,
  },
  props: {
    memoDtoList: Array,
  },
  data() {
    return {
      range: "전체",
      articles: [],
      articles_all: [],
      articleIndex: 0,
      bottom: false,
    };
  },
  methods: {
    moveNewsDetail(articleId) {
      this.$router.push(`/news/${articleId}`);
    },
    // 보여지는 리스트에 메모 추가하기
    addMemo() {
      if (this.articles.length < this.articles_all.length) {
        // +10과 최대 Index 중 최솟값 구하기
        const maxIndex = Math.min(
          this.articles_all.length,
          this.articleIndex + 10
        );
        // 전체 메모 리스트에서 slice해서 memos에 추가
        this.articles.push(
          ...this.articles_all.slice(this.articleIndex, maxIndex)
        );
        // 이미 보여준 마지막 memoIndex 업데이트
        this.articleIndex = maxIndex;
      }
    },
    bottomVisible() {
      const scrollY = window.scrollY;
      const visible = document.documentElement.clientHeight;
      const pageHeight = document.documentElement.scrollHeight;
      // + 73은 Footer의 높이
      const bottomOfPage = visible + scrollY + 73 >= pageHeight;
      return bottomOfPage || pageHeight < visible;
    },
  },
  created() {
    // 스크롤 이동할 때 bottom 변화 확인
    window.addEventListener("scroll", () => {
      this.bottom = this.bottomVisible();
    });

    this.articles_all = this.memoDtoList;
    this.addMemo();
  },
};
</script>

<style></style>
